<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Space Invaders ‚Äî Samuel Barnhurst</title>
  <style>
    :root{
      --bg:#0d1117; --card:#161b22; --ink:#e6edf3; --muted:#30363d; --accent:#00ffff; --accent-2:#00b3b3; --danger:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--ink);
      min-height:100vh; display:flex; flex-direction:column; align-items:center; gap:.75rem; padding:1rem;
    }
    h1{margin:.25rem 0; color:var(--accent); font-weight:800; letter-spacing:.5px}
    .row{display:flex; gap:.75rem; flex-wrap:wrap; align-items:center; justify-content:center}
    .card{background:var(--card); border:1px solid var(--muted); border-radius:12px; padding:.6rem .9rem}
    select, .btn{
      appearance:none; background:var(--card); color:var(--ink);
      border:1px solid var(--muted); border-radius:10px; padding:.6rem .9rem;
      font-weight:600; cursor:pointer; transition:background .2s,color .2s,transform .04s ease-in-out;
    }
    .btn:hover, select:hover{background:#17202a}
    .btn:active{transform:translateY(1px)}
    .btn.primary{border-color:var(--accent-2)}
    .btn.primary:hover{background:var(--accent-2); color:#fff}
    .btn.accent{border-color:var(--accent)}
    .btn.accent:hover{background:var(--accent); color:#001013}
    .hud{
      display:flex; align-items:center; justify-content:center; gap:1.5rem;
      padding:.4rem .9rem; border-radius:10px; border:1px solid var(--muted); background:var(--card)
    }
    .score{font-size:1.25rem; font-weight:800; color:var(--accent)}
    .life{color:var(--danger); font-weight:700}
    .hi{opacity:.9}
    .canvas-wrap{width:min(960px,100%)}
    canvas{
      width:100%; height:auto;
      background:var(--card); border:2px solid var(--accent); border-radius:12px; display:block; margin:.5rem 0 0;
      touch-action:none; /* allow custom pointer controls */
    }
    /* Overlay */
    .overlay{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.55); backdrop-filter:blur(2px); z-index:10;
    }
    .overlay.show{display:flex}
    .modal{
      width:min(560px,92%); background:var(--card); border:1px solid var(--muted); border-radius:14px; padding:1.2rem;
      text-align:center; box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .modal h2{margin:.25rem 0 .5rem; color:var(--accent)}
    .modal p{margin:.25rem 0 .9rem; opacity:.9}
    .modal .row{margin-top:.6rem}
    /* Mobile controls */
    .touch-controls{display:none; gap:.5rem; margin-top:.5rem; flex-wrap:wrap; justify-content:center}
    .pad{min-width:100px; padding:.7rem 1rem; text-align:center; user-select:none}
    @media (max-width: 768px){ .touch-controls{display:flex} }
    :focus-visible{outline:2px solid var(--accent); outline-offset:2px}
  </style>
</head>
<body>
  <h1>üëæ Space Invaders</h1>

  <div class="row">
    <label class="card" for="difficulty">Difficulty:
      <select id="difficulty" aria-label="Difficulty">
        <option value="easy">Easy</option>
        <option value="normal" selected>Normal</option>
        <option value="hard">Hard</option>
        <option value="insane">Insane</option>
      </select>
    </label>

    <div class="hud">
      <span>Score <span class="score" id="score">0</span></span>
      <span>Wave <strong id="wave">1</strong></span>
      <span>Lives <strong class="life" id="lives">3</strong></span>
      <span class="hi">High&nbsp;Score: <strong id="hiScore">0</strong></span>
    </div>

    <div class="row">
      <button class="btn primary" id="restartBtn" aria-label="Restart">üîÅ Restart</button>
      <button class="btn accent" id="pauseBtn" aria-label="Pause or resume">‚è∏Ô∏è Pause</button>
      <button class="btn" id="backBtn" aria-label="Back">‚¨Ö Back</button>
    </div>
  </div>

  <div class="canvas-wrap">
    <!-- Internal res is fixed; CSS scales responsively -->
    <canvas id="game" width="800" height="600" aria-label="Space Invaders game area"></canvas>
  </div>

  <!-- Mobile on-screen controls -->
  <div class="touch-controls" aria-hidden="false">
    <button class="btn pad" id="leftBtn">‚óÄ Left</button>
    <button class="btn pad" id="fireBtn">üî´ Fire</button>
    <button class="btn pad" id="rightBtn">‚ñ∂ Right</button>
  </div>

  <!-- Overlay -->
  <div class="overlay" id="overlay" role="dialog" aria-modal="true" aria-labelledby="ovTitle">
    <div class="modal">
      <h2 id="ovTitle">Game Over</h2>
      <p id="ovText">Score: 0</p>
      <div class="row">
        <button class="btn primary" id="ovRestart">üîÅ Restart</button>
        <button class="btn" id="ovBack">‚¨Ö Back</button>
      </div>
    </div>
  </div>

  <p class="card" style="max-width:960px">
    <strong>Controls:</strong> Left/Right arrows to move ¬∑ <kbd>Space</kbd> shoot ¬∑ <kbd>P</kbd> Pause/Resume ¬∑ <kbd>R</kbd> Restart
  </p>

  <script>
    // ------- Elements
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const difficultySel = document.getElementById('difficulty');
    const scoreEl = document.getElementById('score');
    const waveEl = document.getElementById('wave');
    const livesEl = document.getElementById('lives');
    const hiScoreEl = document.getElementById('hiScore');
    const restartBtn = document.getElementById('restartBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const backBtn = document.getElementById('backBtn');
    const overlay = document.getElementById('overlay');
    const ovTitle = document.getElementById('ovTitle');
    const ovText = document.getElementById('ovText');
    const ovRestart = document.getElementById('ovRestart');
    const ovBack = document.getElementById('ovBack');

    // Mobile buttons
    const leftBtn = document.getElementById('leftBtn');
    const rightBtn = document.getElementById('rightBtn');
    const fireBtn = document.getElementById('fireBtn');

    // ------- Config
    const WIDTH = canvas.width, HEIGHT = canvas.height;
    const HI_KEY = 'invadersHighScore';

    // Player
    const PLAYER_W = 48, PLAYER_H = 20, PLAYER_SPEED = 380; // px/s
    const SHOT_SPEED = 560; // px/s
    const ENEMY_SHOT_SPEED = 300;

    // Invaders
    const COLS_BASE = 10, ROWS_BASE = 5;
    const INV_W = 36, INV_H = 24, INV_PAD_X = 12, INV_PAD_Y = 18;
    const GROUP_MARGIN = 30;
    const DROP_Y = 18; // on edge bounce

    // ------- State
    let running=false, paused=false, rafId=null, lastTs=0;
    let score=0, hiScore=0, wave=1, lives=3;

    let player, shots=[], enemyShots=[];
    let invaders = [], group = {x:0, y:60, dir:1, speed:90, w:0, h:0}; // dir: 1 right, -1 left
    let keys = {left:false, right:false, shoot:false};
    let canShoot = true, shootCooldown=250, shootTimer=0;
    let invaderFireTimer=0, invaderFireInterval=900; // ms
    let spawnSaucer=false, saucer=null; // optional, not used here

    // ------- Helpers
    function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
    function rect(x,y,w,h,c){ ctx.fillStyle=c; ctx.fillRect(x,y,w,h); }
    function text(t,x,y,c,px=18){ ctx.fillStyle=c; ctx.font = `${px}px Arial`; ctx.fillText(t,x,y); }

    function showOverlay(show, title='Game Over', text=''){
      overlay.classList.toggle('show', !!show);
      if (show){ ovTitle.textContent = title; ovText.textContent = text || ovText.textContent; }
    }
    function hideOverlay(){ overlay.classList.remove('show'); }

    function setDifficulty(d){
      // base multipliers
      if (d==='easy'){ group.speed = 80; invaderFireInterval = 1050; }
      else if (d==='normal'){ group.speed = 90; invaderFireInterval = 900; }
      else if (d==='hard'){ group.speed = 110; invaderFireInterval = 750; }
      else { group.speed = 140; invaderFireInterval = 600; }
    }

    function initPlayer(){
      player = { x: (WIDTH-PLAYER_W)/2, y: HEIGHT-50, w: PLAYER_W, h: PLAYER_H, speed: PLAYER_SPEED, invul:0 };
    }

    function buildInvaders(){
      invaders = [];
      const cols = COLS_BASE, rows = ROWS_BASE + Math.floor((wave-1)/2); // add rows over time
      group.x = GROUP_MARGIN; group.y = 60; group.dir = 1;
      group.w = cols*(INV_W+INV_PAD_X)-INV_PAD_X; // width of grid
      group.h = rows*(INV_H+INV_PAD_Y)-INV_PAD_Y;
      for (let r=0; r<rows; r++){
        for (let c=0; c<cols; c++){
          invaders.push({
            gx: c*(INV_W+INV_PAD_X), gy: r*(INV_H+INV_PAD_Y), // grid coordinates
            alive: true
          });
        }
      }
    }

    function resetGame(){
      cancelAnim();
      score = 0; wave = 1; lives = 3;
      shots.length = 0; enemyShots.length = 0;
      setDifficulty(difficultySel.value);
      initPlayer();
      buildInvaders();
      updateHUD();
      hideOverlay();
      start();
    }

    function updateHUD(){
      scoreEl.textContent = String(score);
      waveEl.textContent = String(wave);
      livesEl.textContent = String(lives);
      hiScoreEl.textContent = String(hiScore);
    }

    function start(){
      if (running) return;
      running = true; paused = false; lastTs = performance.now();
      pauseBtn.textContent = '‚è∏Ô∏è Pause';
      rafId = requestAnimationFrame(loop);
    }
    function cancelAnim(){ running=false; if (rafId) cancelAnimationFrame(rafId); rafId=null; }
    function togglePause(){
      if (!running) return;
      paused = !paused;
      pauseBtn.textContent = paused ? '‚ñ∂Ô∏è Resume' : '‚è∏Ô∏è Pause';
      showOverlay(paused, 'Paused', 'Press Resume to continue');
      if (!paused) lastTs = performance.now();
    }

    function nextWave(){
      wave++;
      // speed up a bit and shorten enemy fire interval
      group.speed += 12;
      invaderFireInterval = Math.max(420, invaderFireInterval - 40);
      shots.length=0; enemyShots.length=0;
      buildInvaders();
      updateHUD();
    }

    function gameOver(){
      cancelAnim();
      // high score
      try{
        if (score > hiScore){ hiScore = score; localStorage.setItem(HI_KEY, String(hiScore)); }
      } catch {}
      updateHUD();
      showOverlay(true, 'Game Over', `Score: ${score} ¬∑ High: ${hiScore}`);
    }

    // ------- Input
    document.addEventListener('keydown', e=>{
      const k = e.key;
      if (k === 'ArrowLeft') keys.left = true;
      else if (k === 'ArrowRight') keys.right = true;
      else if (k === ' '){ keys.shoot = true; e.preventDefault(); }
      else if (k === 'p' || k === 'P') togglePause();
      else if (k === 'r' || k === 'R') resetGame();
    });
    document.addEventListener('keyup', e=>{
      const k = e.key;
      if (k === 'ArrowLeft') keys.left = false;
      else if (k === 'ArrowRight') keys.right = false;
      else if (k === ' ') keys.shoot = false;
    });

    // Pointer (mouse/touch) ‚Äî use Pointer Events so it's unified
    function hold(btn, prop){
      btn.addEventListener('pointerdown', ev => { ev.preventDefault(); keys[prop] = true; btn.setAttribute('aria-pressed','true'); });
      const up = ()=>{ keys[prop] = false; btn.setAttribute('aria-pressed','false'); };
      btn.addEventListener('pointerup', up);
      btn.addEventListener('pointercancel', up);
      btn.addEventListener('pointerleave', up);
    }
    hold(leftBtn,'left'); hold(rightBtn,'right');
    fireBtn.addEventListener('pointerdown', ev => { ev.preventDefault(); shoot(); });

    // Buttons
    restartBtn.addEventListener('click', resetGame);
    pauseBtn.addEventListener('click', togglePause);
    backBtn.addEventListener('click', e=>{
      e.preventDefault();
      if (window.history.length > 1) window.history.back();
      else window.location.href = 'games.html'; // adjust path if nested
    });
    ovRestart.addEventListener('click', resetGame);
    ovBack.addEventListener('click', ()=> backBtn.click());

    // Auto-pause when tab hidden
    document.addEventListener('visibilitychange', ()=>{ if (document.hidden && running && !paused) togglePause(); });

    difficultySel.addEventListener('change', ()=>{ setDifficulty(difficultySel.value); resetGame(); });

    // ------- Game loop (rAF)
    function loop(ts){
      if (!running){ return; }
      if (paused){ rafId = requestAnimationFrame(loop); return; }
      const dt = Math.min(0.05, (ts - lastTs)/1000) || (1/60);
      lastTs = ts;
      update(dt);
      render();
      rafId = requestAnimationFrame(loop);
    }

    // ------- Mechanics
    function update(dt){
      // Player move
      if (keys.left)  player.x -= player.speed * dt;
      if (keys.right) player.x += player.speed * dt;
      player.x = clamp(player.x, 0, WIDTH - player.w);
      if (player.invul > 0) player.invul -= dt;

      // Shooting
      if (keys.shoot){ shoot(); }
      if (!canShoot){
        shootTimer += dt*1000;
        if (shootTimer >= shootCooldown){ canShoot = true; shootTimer = 0; }
      }

      // Move shots
      for (let i=shots.length-1;i>=0;i--){
        const s = shots[i]; s.y -= SHOT_SPEED * dt;
        if (s.y < -12) shots.splice(i,1);
      }
      for (let i=enemyShots.length-1;i>=0;i--){
        const s = enemyShots[i]; s.y += ENEMY_SHOT_SPEED * dt;
        if (s.y > HEIGHT+12) enemyShots.splice(i,1);
      }

      // Invader group movement
      const aliveInv = invaders.filter(v=>v.alive);
      if (aliveInv.length === 0){ nextWave(); return; }
      group.x += group.dir * group.speed * dt;

      // Check edges using group bbox
      const gxMin = group.x;
      const gxMax = group.x + group.w;
      if (gxMin < GROUP_MARGIN || gxMax > WIDTH - GROUP_MARGIN){
        group.dir *= -1;
        group.y += DROP_Y;
        group.x = clamp(group.x, GROUP_MARGIN, WIDTH - GROUP_MARGIN - group.w);
        // If invaders reach player line ‚Üí lose life
        if (group.y + group.h >= player.y - 10){ hitPlayer(); }
      }

      // Random enemy fire
      invaderFireTimer += dt*1000;
      if (invaderFireTimer >= invaderFireInterval){
        invaderFireTimer = 0;
        // pick a random alive invader from bottom-most per column
        const columns = {};
        for (const inv of invaders){
          if (!inv.alive) continue;
          const col = inv.gx;
          if (!columns[col] || columns[col].gy < inv.gy) columns[col] = inv;
        }
        const bottoms = Object.values(columns);
        if (bottoms.length){
          const shooter = bottoms[Math.floor(Math.random()*bottoms.length)];
          const sx = group.x + shooter.gx + INV_W/2;
          const sy = group.y + shooter.gy + INV_H;
          enemyShots.push({x:sx, y:sy, w:3, h:10});
        }
      }

      // Collisions: player shots ‚Üí invaders
      for (let i=shots.length-1;i>=0;i--){
        const s = shots[i];
        for (const inv of invaders){
          if (!inv.alive) continue;
          const x = group.x + inv.gx, y = group.y + inv.gy;
          if (aabb(s.x-2, s.y-8, 4, 12, x, y, INV_W, INV_H)){
            inv.alive = false; shots.splice(i,1);
            score += 10; scoreEl.textContent = String(score);
            // speed up slightly as fewer remain
            group.speed += 1.2;
            break;
          }
        }
      }

      // Collisions: enemy shots ‚Üí player
      for (let i=enemyShots.length-1;i>=0;i--){
        const s = enemyShots[i];
        if (aabb(s.x-2, s.y, 4, 10, player.x, player.y, player.w, player.h)){
          enemyShots.splice(i,1);
          hitPlayer();
        }
      }
    }

    function render(){
      // background
      rect(0,0,WIDTH,HEIGHT,'#0f1420');

      // starfield (cheap)
      ctx.fillStyle = '#1c2430';
      for (let i=0;i<60;i++){ ctx.fillRect((i*73)%WIDTH, (i*113)%HEIGHT, 2, 2); }

      // player
      ctx.fillStyle = player.invul>0 ? '#9bffd9' : '#00ffff';
      rect(player.x, player.y, player.w, player.h, ctx.fillStyle);

      // invaders
      for (const inv of invaders){
        if (!inv.alive) continue;
        const x = group.x + inv.gx, y = group.y + inv.gy;
        rect(x, y, INV_W, INV_H, '#9aeaff');
        // simple eyes
        rect(x+6,y+6,6,6,'#0d1117'); rect(x+INV_W-12,y+6,6,6,'#0d1117');
      }

      // shots
      ctx.fillStyle = '#00ffff';
      for (const s of shots){ rect(s.x-2, s.y-8, 4, 12, '#00ffff'); }
      ctx.fillStyle = '#ff6b6b';
      for (const s of enemyShots){ rect(s.x-2, s.y, 4, 10, '#ff6b6b'); }

      // top HUD inside canvas (redundant with DOM HUD; nice in fullscreen)
      text(`S:${score}`, 10, 20, '#e6edf3', 16);
      text(`W:${wave}`, 70, 20, '#e6edf3', 16);
      text(`L:${lives}`, 130, 20, '#e6edf3', 16);
    }

    function aabb(ax,ay,aw,ah,bx,by,bw,bh){
      return ax < bx + bw && ax + aw > bx && ay < by + bh && ay + ah > by;
    }

    function shoot(){
      if (!canShoot) return;
      canShoot = false;
      shots.push({x: player.x + player.w/2, y: player.y, w:3, h:10});
    }

    function hitPlayer(){
      if (player.invul > 0) return;
      lives--; livesEl.textContent = String(lives);
      player.invul = 1.2; // seconds of invulnerability
      if (lives <= 0){ gameOver(); }
    }

    // ------- Boot
    (function boot(){
      // high score
      try{ hiScore = Number(localStorage.getItem(HI_KEY) || 0); } catch { hiScore = 0; }
      updateHUD();
      setDifficulty(difficultySel.value);
      initPlayer();
      buildInvaders();
      // start loop
      start();
    })();
  </script>
</body>
</html>
